name: transcendence

#Env file template
# POSTGRES_USER=postgres
# POSTGRES_PASSWORD=postgres
# POSTGRES_HOST=db
# POSTGRES_PORT=5432

# POSTGRES_DB_AUTH=auth
# POSTGRES_DB_USERS=users

services:

  nginx:
    container_name: nginx_c
    image: nginx
    ports:
      - 8083:443
      - 8080:80
    volumes:
      - ./frontend/:/www/html/
      - ${DATA_DIR}logs/nginx/:/var/log/nginx/:rw
      - ./srcs/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ${DATA_DIR}keys/ssl/ssl.crt:/etc/certificate/ssl.crt
      - ${DATA_DIR}media/avatars/:/www/html/avatars/:ro
    secrets:
      - ssl-key
    depends_on:
      - auth_api

  db:
    container_name: db_c
    image: postgres
    volumes:
      - ${DATA_DIR}db:/var/lib/postgresql/data
      - ./srcs/scripts/db_entrypoint:/docker-entrypoint-initdb.d
    environment:
      - POSTGRES_MULTIPLE_DATABASES=${POSTGRES_DB_AUTH},${POSTGRES_DB_USERS}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

  auth_api:
    container_name: auth_api_c
    build:
      context: ./srcs/django_builds
      target: django_authapi
    command: python3 manage.py runserver 0.0.0.0:8000
    volumes:
      - ./srcs/backend/auth/:/code
      - ${DATA_DIR}keys/rsa/pub.pem:/etc/certificate/pub.pem
      - ${DATA_DIR}keys/api-tokens/auth:/etc/certificate/api-token
    ports:
      - "8000:8000"
    depends_on:
      - db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_DB=${POSTGRES_DB_AUTH}
      - ISSUER_URL=${AUTH_ISSUER_URL}
      - ALLOWED_APIS=${AUTH_API_ALLOWED_APIS}
      - API42_UUID=${API42_UUID}
      - API42_SECRET=${API42_SECRET}
    secrets:
      - rsa-key
    restart: always

  redis:
    container_name: redis_c
    image: redis
    ports:
      - "8008:6379"

  websocket_example:
    container_name: websocket_c
    build:
      context: ./srcs/django_builds
      target: django_websocketapi
    ports:
      - "8002:8002"
    command: python3 manage.py runserver 0.0.0.0:8002
    depends_on:
        - redis
    volumes:
      - ./srcs/backend/websocket_example/:/code
      - ${DATA_DIR}keys/rsa/pub.pem:/etc/certificate/pub.pem
      - ${DATA_DIR}keys/api-tokens/pong:/etc/certificate/api-token

  users_api:
    container_name: users_api_c
    build:
      context: ./srcs/django_builds
      target: django_usersapi
    command: python3 manage.py runserver 0.0.0.0:8001
    volumes:
      - ./srcs/backend/users/:/code
      - ${DATA_DIR}keys/rsa/pub.pem:/etc/certificate/pub.pem
      - ${DATA_DIR}keys/api-tokens/users:/etc/certificate/api-token
      - ${DATA_DIR}/media/avatars:/avatars/
    ports:
      - "8001:8001"
    depends_on:
      - db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_DB=${POSTGRES_DB_USERS}
      - ALLOWED_APIS=${USERS_API_ALLOWED_APIS}
    restart: always

  # web2:
  #   container_name: web2_c
  #   build:
  #     context: ./srcs/django_builds
  #     target: django_main
  #   command: python manage.py runserver 0.0.0.0:8001
  #   volumes:
  #     - ./srcs/backend/webapp/code:/code
  #   ports:
  #     - "8001:8001"
  #   env_file: ./.env
  #   depends_on:
  #     - db

secrets:
  ssl-key:
    file: ${DATA_DIR}keys/ssl/ssl.key
  rsa-key:
    file: ${DATA_DIR}keys/rsa/key.pem
