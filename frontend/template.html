<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plus2Chicos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #content {
            margin-top: 70px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div id='menu' class="container-fluid">
            <a class="navbar-brand" href="#matchmaking">SPA Jeux</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#matchmaking">Matchmaking</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#stats">Statistiques</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#about">À propos</a>
                    </li>
                </ul>
                <div id="user-button" class="dropdown" style="display:none;">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="avatars/__default__.jpg" alt="Avatar" width="30" height="30" class="rounded-circle">
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                        <li><a class="dropdown-item" href="#profile">Profil</a></li>
                        <li><a class="dropdown-item" href="#" id="logout">Déconnexion</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div id="content">
        <!-- Le contenu dynamique sera chargé ici -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration des routes
        const routes = {
            login: { url: '/login.html', script: null },
            profile: { url: '/profile.html', script: '/profile.js' },
            about: { url: '/about.html', script: null },
            stats: { url: '/stats.html', script: '/stats.js' },
            matchmaking: { url: '/matchmaking.html', script: null },
            pong2d: { url: '/pong2d.html', script: '/script_pong.js' },
            pong3d: { url: '/pong3d.html', script: null }
        };

		// Gestion des nettoyages
		const cleanupFunctions = {
			pong2d: null,
			pong3d: null,
			// Ajoutez d'autres pages si nécessaire
		};

		const initFunctions = {
			pong2d: null,
			pong3d: null,
			// Ajoutez d'autres pages si nécessaire
		};

        // Gestionnaire de navigation
        function navigateTo(route) {
            history.pushState(null, '', route);
			if (route !== '#login' && checkAuth() == false)
				navigateTo('#login')
			else {
            	loadContent(route);
				if (checkAuth() === true)
					document.getElementById('user-button').style.display = 'block';
			}
        }


		function registerCleanup(pageName, cleanupFunction) {
			cleanupFunctions[pageName] = cleanupFunction;
		}

		function cleanup() {
			Object.values(cleanupFunctions).forEach(cleanupFunc => {
				if (typeof cleanupFunc === 'function') {
					cleanupFunc();
				}
			});
		}

		function registerInit(pageName, initFunction) {
			initFunctions[pageName] = initFunction;
		}

		function init() {
			Object.values(initFunctions).forEach(initFunc => {
				if (typeof initFunc === 'function') {
					initFunc();
				}
			});
		}

        // Chargement du contenu
        async function loadContent(route) {
			cleanup();
			const routeInfo = routes[route.slice(1)] || routes.matchmaking;
			
			try {
				const response = await fetch(routeInfo.url);
				const content = await response.text();
				const tempDiv = document.createElement('div');
				tempDiv.innerHTML = content;
				
				// Gérer l'import map
				const importMapScript = tempDiv.querySelector('script[type="importmap"]');
				if (importMapScript) {
					const existingImportMap = document.querySelector('script[type="importmap"]');
					if (existingImportMap) {
						existingImportMap.remove();
					}
					const newImportMapScript = document.createElement('script');
					newImportMapScript.type = 'importmap';
					newImportMapScript.textContent = importMapScript.textContent;
					document.head.appendChild(newImportMapScript);
					// Attendre un court instant pour s'assurer que l'import map est traité
					await new Promise(resolve => setTimeout(resolve, 100));
				}

				// Exécuter les scripts inline et externes
				tempDiv.querySelectorAll('script').forEach(script => {
					if (!script.src && script.textContent) {
						const newScript = document.createElement('script');
						newScript.textContent = `(function() { ${script.textContent} })();`;
						document.body.appendChild(newScript);
					} else if (script.src) {
						const newScript = document.createElement('script');
						newScript.src = script.src;
						newScript.type = script.type || 'text/javascript';
						document.body.appendChild(newScript);
					}
				});

				document.getElementById('content').innerHTML = tempDiv.innerHTML;
				init();

				if (routeInfo.script) {
					const script = document.createElement('script');
					script.src = routeInfo.script;
					script.type = 'module';
					document.body.appendChild(script);
				}
			} catch (error) {
				console.error('Erreur lors du chargement du contenu:', error);
			}
		}

        // Gestion des événements de navigation
        window.addEventListener('popstate', () => {
            loadContent(window.location.hash);
        });

        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'A' && e.target.href.startsWith(window.location.origin) && !e.target.closest('form')) {
                e.preventDefault();
                navigateTo(new URL(e.target.href).hash);
            }
        });

        // Vérification de l'authentification
        function checkAuth() {
            // Simuler la vérification du cookie d'authentification
            const isAuthenticated = document.cookie.includes('auth-token');
            if (!isAuthenticated)
				return false;
			return true;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
			if (checkAuth() === true)
				document.getElementById('user-button').style.display = 'block';
			loadContent(window.location.hash || '#matchmaking');
		});

        // Gestion de la déconnexion
        document.getElementById('logout').addEventListener('click', (e) => {
            e.preventDefault();
            // Simuler la déconnexion
            document.cookie = 'auth-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
			document.getElementById('user-button').style.display = 'none';
            navigateTo('#login');
        });
    </script>
</body>
</html>