<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Système de Matchmaking</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		body {
			background-color: #f8f9fa;
			height: 100vh;
			display: flex;
			flex-direction: column;
		}
		.container {
			flex-grow: 1;
			display: flex;
			flex-direction: column;
		}
		.lobby-list {
			flex-grow: 1;
			overflow-y: auto;
			margin-bottom: 20px;
		}
		.table {
			background-color: #fff;
		}
		.table-hover tbody tr:hover {
			background-color: #f5f5f5;
		}
		.tournament {
			border-left: 5px solid #ffc107;
		}
		.side-buttons {
			display: flex;
			flex-direction: row;
			/* right: 20px; */
			margin-top: 20px;
			justify-content: center;
			/* top: 50%; */
			/* width: 1 */
			/* transform: translateY(-50%); */
		}
		.side-buttons .btn {
			margin-bottom: 10px;
			margin-left: 15px;
			margin-right: 15px;
		}
		.btn, .form-control {
			border-radius: 2px;
		}
		.modal-content {
			border-radius: 2px;
		}

	</style>
</head>
<body>
	<div class="container mt-4" id="mainView">
		<h1 class="mb-4">Système de Matchmaking</h1>

		<div class="row">
			<div class="col-md-6">
				<h2>Lobbies disponibles</h2>
				<div id="availableLobbies" class="lobby-list">
					<table class="table table-hover">
						<thead>
							<tr>
								<th>Nom</th>
								<th>Type</th>
								<th>Host</th>
								<th>Places</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</div>
			<div class="col-md-6">
				<h2>Matchs en cours</h2>
				<div id="ongoingMatches" class="lobby-list">
					<table class="table table-hover">
						<thead>
							<tr>
								<th>Nom</th>
								<th>Type</th>
								<th>Host</th>
								<th>Places</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</div>
		</div>

		<div class="side-buttons">
			<button class="btn btn-primary mainView" onclick="createLobby()">Créer un lobby</button>
			<button class="btn btn-success mainView" onclick="createTournament()">Créer un tournoi</button>
			<button class="btn btn-info mainView" data-bs-toggle="modal" data-bs-target="#joinLobbyModal">Rejoindre un lobby</button>
			<button class="btn btn-secondary mainView" onclick="showOnlinePlayers()">Joueurs en ligne</button>
		</div>

	</div>

	<div class="container mt-4" id="lobbyView" style="display:none;">
		<h1 class="mb-4">Lobby: <span id="lobbyName"></span></h1>
	
		<div class="row">
			<table class="table table-hover">
				<thead>
					<tr>
						<th>Nom du joueur</th>
						<th>État</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody id="playerList">
					<!-- Liste des joueurs insérée ici via WebSocket -->
				</tbody>
			</table>
		</div>

		<div class="side-buttons">
			<!-- Boutons globaux -->
			 <!-- Si l'utilisateur est l'hôte, afficher les options supplémentaires -->
			<div id="hostOptions" style="display:none;">
				<button class="btn btn-warning" onclick="openLobbyOptions()">Modifier les options du lobby</button>
				<button class="btn btn-sucess" onclick="startGame()">Démarrer le jeu</button>
			</div>
			<button class="btn btn-secondary lobbyView" style="display:none;" onclick="inviteFriends()">Inviter des amis</button>
			<button class="btn btn-warning lobbyView" style="display:none;" onclick="beReady()">Pret</button>
			<button class="btn btn-danger lobbyView" style="display:none;" onclick="leaveLobby()">Quitter le lobby</button>
		</div>

	</div>

	<!-- Modal pour rejoindre un lobby -->
	<div class="modal fade" id="joinLobbyModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Rejoindre un lobby</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<input type="text" id="lobbyIdInput" class="form-control" placeholder="ID du lobby">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
					<button type="button" class="btn btn-primary" onclick="joinLobbyById()">Rejoindre</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal pour afficher les joueurs en ligne -->
	<div class="modal fade" id="onlinePlayersModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Joueurs en ligne</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body" id="onlinePlayersList">

				</div>
			</div>
		</div>
	</div>

	<!-- Modale pour inviter des amis -->
	<div class="modal fade" id="inviteFriendsModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Inviter des amis</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body" id="friendList">
					<!-- Liste des amis à inviter générée ici -->
				</div>
			</div>
		</div>
	</div>

	<!-- Modale pour changer les options du lobby -->
	<div class="modal fade" id="lobbyOptionsModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Modifier les options du lobby</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<label for="gameType">Type de jeu</label>
					<select id="gameType" class="form-control">
						<option value="pong2d">Pong 2D</option>
						<option value="pong3d">Pong 3D</option>
					</select>

					<label for="lobbyNameInput">Nom du lobby</label>
					<input type="text" id="lobbyNameInput" class="form-control">

					<label for="slotCount">Nombre de slots disponibles</label>
					<input type="number" id="slotCount" class="form-control">

					<label for="livesCount">Nombre de vies</label>
					<input type="number" id="livesCount" class="form-control">

					<div class="form-check">
						<input type="checkbox" class="form-check-input" id="allowSpectators">
						<label class="form-check-label" for="allowSpectators">Autoriser les spectateurs</label>
					</div>

					<button class="btn btn-primary" onclick="saveLobbyOptions()">Sauvegarder</button>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
	<script>

		let socket;
		let isHost= false;
		let lobbyId;

		class WebSocketHandler {
			constructor(url, dispatcher) {
				this.url = url;
				this.socket = null;
				this.isConnected = false;
				this.dispatcher = dispatcher;
				this.messageQueue = [];
			}

			connect() {
				this.socket = new WebSocket(this.url);

				this.socket.onopen = () => {
					console.log('WebSocket connected');
					this.isConnected = true;
					this.flushQueue();
				};

				this.socket.onmessage = (event) => {
					const message = JSON.parse(event.data);
					this.handleMessage(message);
				};

				this.socket.onclose = () => {
					console.log('WebSocket disconnected');
					this.isConnected = false;
					// Implement reconnection logic here if needed
				};

				this.socket.onerror = (error) => {
					console.error('WebSocket error:', error);
				};
			}

			sendMessage(message) {
				if (this.isConnected) {
					this.socket.send(JSON.stringify(message));
				} else {
					this.messageQueue.push(message);
				}
			}

			flushQueue() {
				while (this.messageQueue.length > 0) {
					const message = this.messageQueue.shift();
					this.sendMessage(message);
				}
			}

			handleMessage(message) {
				// Implement message handling logic here
				console.log('Received message:', message);
				this.dispatcher(JSON.parse(message))
				// Example: You might want to dispatch the message to a game state handler
				// gameStateHandler.processMessage(message);
			}

			disconnect() {
				if (this.socket) {
					this.socket.close();
				}
			}
		}



		function connectWebSocket() {
			socket = new WebSocketHandler(`wss://${location.hostname}:8083/ws/matchmaking/anonymous/`, dispatchMessage)
			socket.connect();
		}


		function general_update(message) {
			const availableLobbiesEl = document.querySelector('#availableLobbies tbody');
			const ongoingMatchesEl = document.querySelector('#ongoingMatches tbody');

			availableLobbiesEl.innerHTML = '';
			ongoingMatchesEl.innerHTML = '';

			message.availableLobbies.forEach(lobby => {
				const [id, obj] = Object.entries(lobby)[0];
				availableLobbiesEl.innerHTML += createLobbyHTML(id, obj, true);
			});

			message.ongoingMatches.forEach(match => {
				const [id, obj] = Object.entries(match)[0];
				ongoingMatchesEl.innerHTML += createLobbyHTML(id, obj, false);
			});
		}

		function createLobbyHTML(id, lobby, isAvailable) {
			// console.log(id)
			const tournamentClass = lobby.match_type == 'tournament_lobby' ? 'tournament' : '';
			const actionButton = isAvailable
				? `<button class="btn btn-sm btn-primary" onclick="joinLobby('${id}')">Rejoindre</button>`
				: `<button class="btn btn-sm btn-secondary" onclick="observeMatch('${id}')">Observer</button>`;

			return `
				<tr class="${tournamentClass}" id="${id}">
					<td>${lobby.name}</td>
					<td>${lobby.game_type}</td>
					<td>${lobby.host}</td>
					<td>${lobby.slots}</td>
					<td>${actionButton}</td>
				</tr>
			`;
		}

		function createLobby() {
			// Logique pour créer un lobby
			console.log('Création d\'un nouveau lobby');
		}

		function createTournament() {
			// Logique pour créer un tournoi
			console.log('Création d\'un nouveau tournoi');
		}

		function joinLobbyById() {
			const lobbyId = document.getElementById('lobbyIdInput').value;
			console.log('Rejoindre le lobby avec l\'ID:', lobbyId);
			// Implémentez la logique pour rejoindre le lobby ici
		}

		function switchLobbyView() {

			console.log(`lobby=${lobbyId}`)
			document.getElementById('mainView').style.display = (lobbyId === undefined ? 'none' : 'block');
			document.getElementById('lobbyView').style.display = (lobbyId === undefined ? 'block' : 'none');
			// Pour tous les éléments avec la classe 'mainView'
			document.querySelectorAll('.mainView').forEach(function(element) {
				element.style.display = (lobbyId === undefined ? 'none' : 'block');
			});

			// Pour tous les éléments avec la classe 'lobbyView'
			document.querySelectorAll('.lobbyView').forEach(function(element) {
				element.style.display = (lobbyId === undefined ? 'block' : 'none');
			});

			// Recevoir les détails du lobby via WebSocket
			// socket.sendMessage({ type: 'getLobbyDetails', lobbyId: lobbyId });
		}

		function joinLobby(lobbyId) {
			console.log('Rejoindre le lobby:', lobbyId);
			// Implémentez la logique pour rejoindre le lobby ici
			socket.sendMessage({ type: 'join_lobby', lobby_id: lobbyId });
			switchLobbyView(lobbyId);
			lobbyId = lobbyId
		}

		function leaveLobby() {
			console.log('Quitter le lobby:', lobbyId);
			// socket.sendMessage({ type: 'leave_lobby', lobbyId: lobbyId });
			switchLobbyView()
			lobbyId = null
		}

		function lobby_update(message) {
			const lobbyNameEl = document.getElementById('lobbyName');
			const playerListEl = document.getElementById('playerList');
			const hostOptionsEl = document.getElementById('hostOptions');

			lobbyNameEl.textContent = message.lobbyName;
			playerListEl.innerHTML = '';  // Vider la liste avant mise à jour

			message.players.forEach(player => {
				const playerRow = document.createElement('tr');
				const playerState = player.isReady ? 'Prêt' : (player.hasJoined ? 'A rejoint' : 'N\'a pas encore rejoint');
				
				playerRow.innerHTML = `
					<td>${player.name}</td>
					<td>${playerState}</td>
					<td>
						${isHost && player.id !== message.hostId ? `<button class="btn btn-danger" onclick="kickPlayer('${player.id}')">Expulser</button>` : ''}
					</td>
				`;
				playerListEl.appendChild(playerRow);
			});

			// Gérer les slots libres
			for (let i = message.players.length; i < message.maxSlots; i++) {
				const emptySlotRow = document.createElement('tr');
				emptySlotRow.classList.add('text-muted');
				emptySlotRow.innerHTML = `
					<td>Slot libre</td>
					<td>En attente</td>
					<td>${isHost ? `<button class="btn btn-info" onclick="addBot()">Ajouter un bot</button>` : ''}</td>
				`;
				playerListEl.appendChild(emptySlotRow);
			}

			// Si c'est l'hôte, afficher les options supplémentaires
			if (message.hostId === currentPlayerId) {
				isHost = true;
				hostOptionsEl.style.display = 'block';
			} else {
				isHost = false;
				hostOptionsEl.style.display = 'none';
			}
		}

		function kickPlayer(playerId) {
			// socket.sendMessage({ type: 'kickPlayer', playerId: playerId });
		}

		function inviteFriends() {
			// Afficher la modale pour inviter des amis
			new bootstrap.Modal(document.getElementById('inviteFriendsModal')).show();
		}

		function addBot() {
			socket.sendMessage({ type: 'addBot' });
		}

		function openLobbyOptions() {
			new bootstrap.Modal(document.getElementById('lobbyOptionsModal')).show();
		}

		function saveLobbyOptions() {
			const options = {
				gameType: document.getElementById('gameType').value,
				lobbyName: document.getElementById('lobbyNameInput').value,
				slotCount: document.getElementById('slotCount').value,
				livesCount: document.getElementById('livesCount').value,
				allowSpectators: document.getElementById('allowSpectators').checked
			};

			socket.sendMessage({ type: 'updateLobbyOptions', options });
		}

		function observeMatch(matchId) {
			console.log('Observer le match:', matchId);
			// Implémentez la logique pour observer le match ici
		}

		function showOnlinePlayers() {
			// Demander la liste des joueurs en ligne via WebSocket
			socket.send(JSON.stringify({ type: 'getOnlinePlayers' }));
		}

		function displayOnlinePlayers(players) {
			const onlinePlayersList = document.getElementById('onlinePlayersList');
			onlinePlayersList.innerHTML = '';

			players.forEach(player => {
				let actionButton = '';
				switch (player.status) {
					case 'in_game':
						actionButton = `<button class="btn btn-sm btn-secondary" onclick="observeMatch('${player.matchId}')">Observer</button>`;
						break;
					case 'in_lobby':
						actionButton = `<button class="btn btn-sm btn-primary" onclick="joinLobby('${player.lobbyId}')">Rejoindre</button>`;
						break;
				}

				onlinePlayersList.innerHTML += `
					<div class="player-item">
						<p>${player.name} - Status: ${player.status}</p>
						${actionButton}
					</div>
				`;
			});

			// Afficher le modal
			new bootstrap.Modal(document.getElementById('onlinePlayersModal')).show();
		}

		// Connecter le WebSocket au chargement de la page
		function dispatchMessage(message) {
			console.log(message.type)
			if (typeof window[message.type] === "function") {
				window[message.type](message);
			} else {
				console.error(`Received a message type which has no handler: ${message.type}`);
			}
		}

		window.onload = connectWebSocket;
	</script>
</body>
</html>
